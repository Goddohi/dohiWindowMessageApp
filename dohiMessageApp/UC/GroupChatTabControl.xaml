<UserControl x:Class="WalkieDohi.UC.GroupChatTabControl"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:WalkieDohi.UC"
    xmlns:entity="clr-namespace:WalkieDohi.Entity"
      mc:Ignorable="d" 
      Height="Auto" Width="Auto">
    <UserControl.Resources>
        <!-- 텍스트 메시지용 -->
        <DataTemplate DataType="{x:Type entity:TextMessage}">
            <Grid Margin="5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{Binding Sender}" FontWeight="Bold"/>

                <Grid Grid.Column="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- 메시지 내용 -->
                    <TextBlock Grid.Column="0"
                   Text="{Binding Text}"
                   TextWrapping="Wrap"
                   VerticalAlignment="Top" />

                    <!-- 시간: 오른쪽 고정 -->
                    <TextBlock Grid.Column="1"
                   Text="{Binding Timestamp, StringFormat='{}{0:MM-dd HH:mm}'}"
                   VerticalAlignment="Top"
                   HorizontalAlignment="Right"
                   Margin="10,0,0,0"/>
                </Grid>
            </Grid>
        </DataTemplate>

        <!-- 이미지 메시지용 -->
        <DataTemplate DataType="{x:Type entity:ImageMessage}">
            <Grid Margin="5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100"/>
                    <!-- Sender -->
                    <ColumnDefinition Width="*"/>
                    <!-- Image + Time -->
                </Grid.ColumnDefinitions>

                <!-- Sender -->
                <TextBlock Grid.Column="0" Text="{Binding Sender}" FontWeight="Bold"/>

                <!-- 내부 메시지 + 시간 정렬 -->
                <Grid Grid.Column="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- 이미지 -->
                    <Image Grid.Column="0"
                   MaxWidth="500"
                   MaxHeight="300"
                   Stretch="Uniform"
                   Source="{Binding Image}" />

                    <!-- 시간 -->
                    <TextBlock Grid.Column="1"
                       Text="{Binding Timestamp, StringFormat='{}{0:MM-dd HH:mm}'}"
                       VerticalAlignment="Bottom"
                       Margin="10,0,0,0"/>
                </Grid>
            </Grid>
        </DataTemplate>

        <!-- 파일 메시지용 -->
        <DataTemplate DataType="{x:Type entity:FileMessage}">
            <Grid Margin="5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100"/>
                    <!-- Sender -->
                    <ColumnDefinition Width="*"/>
                    <!-- File + Time -->
                </Grid.ColumnDefinitions>

                <!-- Sender -->
                <TextBlock Grid.Column="0" Text="{Binding Sender}" FontWeight="Bold"/>

                <!-- 내부 파일 + 시간 정렬 -->
                <Grid Grid.Column="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- 파일 내용 -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <TextBlock Text="[파일] " Foreground="Blue" FontWeight="Bold"/>
                        <TextBlock Text="{Binding FileName}" Foreground="Blue" ToolTip="클릭하여 파일 위치 보기"/>
                    </StackPanel>

                    <!-- 시간 -->
                    <TextBlock Grid.Column="1"
                       Text="{Binding Timestamp, StringFormat='{}{0:MM-dd HH:mm}'}"
                       VerticalAlignment="Center"
                       Margin="10,0,0,0"/>
                </Grid>
            </Grid>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <!-- Expander -->
            <RowDefinition Height="*" />
            <!-- Chat list -->
            <RowDefinition Height="Auto" />
            <!-- Input & Send -->
        </Grid.RowDefinitions>

        <!-- 그룹원 목록 Expander -->
        <Expander Header="그룹원 보기" Grid.Row="0" Margin="5" IsExpanded="False">
            <ListBox x:Name="GroupMemberList" Height="100" DisplayMemberPath="DisplayText"/>
        </Expander>

        <!-- 채팅 메시지 리스트 -->
        <ListBox x:Name="ChatList" 
                   SelectionMode="Single"
                   VirtualizingPanel.ScrollUnit="Pixel" 
                   AllowDrop="True"
                   ItemsSource="{Binding ChatMessages}"
                   MouseDoubleClick="ChatList_MouseDoubleClick" 
                   MouseRightButtonUp="ChatList_MouseRightButtonUp"
                   DragEnter="ChatList_DragEnter"
                   Drop="ChatList_Drop"
                   PreviewKeyDown="ChatList_PreviewKeyDown"
                   PreviewMouseWheel="ChatList_ScrollChanged" 
                   ScrollViewer.VerticalScrollBarVisibility="Auto"
                   Grid.Row="1" Margin="5">
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemsPanel>
                <ItemsPanelTemplate>
                    <VirtualizingStackPanel IsVirtualizing="True" VirtualizationMode="Recycling" />
                </ItemsPanelTemplate>
            </ListBox.ItemsPanel>
        </ListBox>

        <Button Grid.Row="1"
            x:Name="ScrollToBottomButton"
            Content="▼"
            Width="30" Height="30"
            HorizontalAlignment="Right"
            VerticalAlignment="Bottom"
            Margin="10,10,30,15"
            Visibility="Collapsed"
            Style="{StaticResource RoundedChatButtonStyle}"
            Click="ScrollToBottomButton_Click"/>


        <!-- 입력창 및 버튼 -->
        <Grid Grid.Row="2" Margin="5" VerticalAlignment="Center" HorizontalAlignment="Left">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300*" />
                <ColumnDefinition Width="80" />
                <ColumnDefinition Width="100" />
            </Grid.ColumnDefinitions>

            <TextBox Grid.Column="0" x:Name="InputBox"  Width="300" Height="30" Margin="0,0,5,0" 
                     PreviewKeyDown="InputBox_PreviewKeyDown" AcceptsReturn="True" />
            <Button Grid.Column="1" x:Name="SendButton" Content="전송" 
                    Style="{StaticResource RoundedChatButtonStyle}" Width="60" Height="30"/>
            <Button Grid.Column="2" Content="파일 전송" Margin="10,0,0,0" 
                    Style="{StaticResource RoundedChatButtonStyle}" Width="80" Height="30" Click="SendFileButton_Click"/>
        </Grid>
    </Grid>
</UserControl>
